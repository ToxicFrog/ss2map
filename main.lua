#!/usr/bin/env lua
require 'util'
local DB = require 'db'
local mapgen = require 'mapgen'

flags.register('help', 'h', '?') {
  help = 'display this text';
}

flags.register('gamesys') {
  help = 'path to gamesys, e.g. shock.gam';
  type = flags.string;
}

flags.register('proplist') {
  help = 'path to proplist.txt generated by in-game :dump_props_full command';
  type = flags.string;
}

flags.register('mapgen') {
  help = 'generate HTML map viewer and immediately exit';
}

flags.register('genimages') {
  help = 'generate terrain images. This is very expensive so if the terrain hasn\'t changed consider turning it off.';
  default = true;
}

local function main(...)
  local args = flags.parse {...}
  if args.help or #args < 1 then
    print('Usage: mismap [flags] [--gamesys=shock.gam] [--proplist=proplist.txt] map.mis')
    print(flags.help())
    os.exit(1)
  end

  local db = DB.new()

  if args.proplist then
    print('PROPS', args.proplist)
    db:load_proplist(args.proplist)
  else
    print('WARNING: no --proplist specified, entity property data will be unavailable')
  end

  if args.gamesys then
    print('GAMESYS', args.gamesys)
    db:load(args.gamesys)
  end

  local maps = {}
  for i,mis in ipairs(args) do
    print('MAP', mis)
    maps[i] = db:clone()
    maps[i]:load(mis)
    maps[i].name = mis
  end

  if args.mapgen then
    mapgen(maps)
    os.exit(0)
  end

  return maps
end

if love then
  require 'love2d' (main)
else
  return main(...)
end
